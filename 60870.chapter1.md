IEC 60870-5-104 入门  
=========================
1.范围和目的
-------------------

DL/T 634.5104-2002协议完全遵循IEC60870-5-1~IEC 60870-5-5的内容，而且规定了IEC 60870-5-101 的应用层与TCP/IP提供的传输功能的结合。

2.应用必读
----------------------

###2.1应用环境
网络通信协议：  
（1）专用光纤或数据网。  
（2）需要辅助设备：  
1）网络接口；  
2）交换机；  
3）路由器；  
4）光纤收发器；  
5）协议转换器。  
###2.2常用名词
####2.2.1  APCI
应用规约控制信息。包含启动字符、APDU长度和控制域。  
####2.2.2  APDU
应用规约数据单元。包含控制域和应用服务数据单元。  
####2.2.3  ASDU
应用服务数据单元。由数据单元标志和信息体组成。
####2.2.4  K
发送方未被确认的I格式的APDU的最大数目。  
####2.2.5  W
接收方最多收到未被确认的I格式的APDU的数目。  
####2.2.6  t0
网络建立链接超时时间。  
####2.2.7  t1
发送或测试APDU的超时时间。  
####2.2.8  t2  
接收方无数据报文时确认的超时时间。 
####2.2.9  t3
通道长期空闲时发送确认帧的超时时间。  
####2.2.10  I格式
I格式（Information Transmit Format)，指需要发送编号的信息传输格式。  
####2.2.11  S格式
S格式（Numbered Supervisory Function)，用于给对方I格式报文确认的监视功能格式，S格式报文本身不需要发送编号。  
####2.2.12  U格式
U格式（Unnumbered Control Function)，不编号的控制功能格式，既没有发送序号也没有接收序号。主要用于控制信息传输流程。  
####2.2.13  端口号
应用层的应用程序用它作为一个发送和接收的地址，不同应用程序一般固定使用不同的端口号，IEC 60870-5-104固定使用2404端口号。  
####2.2.14  客户端
在TCP/IP通信中，接受服务的一方被称为客户端。在 IEC 60870-5-104 协议中主站端一般是召唤数据的一方，因此将主站端定义为客户端。  
####2.2.15  服务器端
在TCP/IP通信中，提供服务的一方被称为服务器端。在 IEC 60870-5-104 协议中厂站端一般是提供数据的一方，因此将厂站端定义为服务器端。  
###2.3 体系结构
IEC 60870-5-104 协议定义了开放的TCP/IP接口的使用，包含一个由IEC 60870-5-101 ASDU 的远动设备构成的局域网的例子。包含不同广域网类型（如X.25、帧中继、ISDN等）的路由器可通过公共的TCP/IP-局域网接口互联（见图1）。图1所示为一个冗余的主站配置与一个非冗余的主站配置。  
![images](/images/图1.PNG)

 
###2.4 规约结构
图2所示为终端洗系统的规约结构。  
图3所示为本标准推荐使用的TCP/IP协议子集（RFC2200）。本协议出版时，RFC文件均为有效，但可能在某时被等效的RFC文件所取代。如图1所示的例子，以太网802.3栈均可能被用于远动站终端系统或DTE（数据终端设备）驱动一单独的路由器。如果不要求冗余，可以用点对点的接口（如X.21）代替局域网接口到单独的路由器，这样可以在对原先支持IEC 60870-5-101 的终端系统进行转化时，保留更多本来的硬件。  
#IEC 104报文格式及其数据结构
##1 基本报文格式
### 1.1应用规约数据单元（APDU)

IEC60870-5-104规定一个APDU报文最长为255个字节(包括启动字符和长度标识)，所以APDU的最大长度为253，APDU长度包括APCI的4个控制 域8位位组和ASDU，因此ASDU的最大长度为249，这一规定限制了一个APDU报文最多能发送121个不带品质描述的归一化测量值或243个不带时标的单点遥信信息，如果子站RTU或监控 系统采集的信息量超过此数目，则须分成多个APDU进行发送。
  
传输接口（TCP到用户）是一个定向流接口，它没有为IEC 60870-5-101中的ASDU定义任何启动或者停止机制，为了检出ASDU的启动和结束，每个APCI（见图4）包括下列的定界元素：  
    
 
   启动字符68H  
   APDU长度(最大253)  
   控制 域8位位组1  
   控制 域8位位组2  
   控制 域8位位组3  
   控制 域8位位组4  
   IEC60870-5-101和IEC60870-5-104中定义的ASDU 
 
（1）启动字符68H，定义了数据流中的起点。   
（2）APDU的长度，定义了APDU体的长度，它包括APCI的四个控制域八位位组和ASDU。第一个被计数的八位位组是控制域的第一个八位位组，最后一个被计数的八位位组是ASDU的最后一个八位位组。  
（3）控制域，定义了保护报文不致丢失和重复传送的控制信息，报文传输启动、停止，以及传输连接的监视。   

### 1.2如何区分三种格式的报文
####I格式（Information Transmit Format)  
（指需要发送编号的信息传输格式。）  
（1）I格式报文的标志是在于：  
1）控制域第一位八位位组的第一位比特=0；  
2）控制域第三个八位位组第一位比特=0。  
（2）特别规定：   
1）只有I格式报文才能用于传送ASDU。I格式的APDU至少包含一个ASDU。  
2）I格式报文必须有发送序号计数和给对方I格式信息确认的接收序号计数。  
3）凡是传送遥测、遥信、遥控、遥调等信息都只能使用I格式报文。  
 （3）I格式的报文结构如下所示：  

0 1 1 0 1 0 0 0  
ASDU长度加4  
发送序列号N（S） |0  
发送序列号N（S）   
接收序列号N（R） |0  
接收序列号N（R）   
ASDU   

1）发送序号是由发送端对所发I格式报文的连续编号。  
2）接收序列号是接收端正确接收I格式报文的编号。  
####S格式（Numbered Supervisory Function)  
（用于给对方I格式报文确认的监视功能格式，S格式报文本身不需要发送编号。）   
（1）S格式报文的标志是在于：  
1）控制域第一位八位位组的第一位比特=1并且第二位比特等于0；  
2）控制域第三个八位位组第一位比特=0。   
（2）特别规定：  
1）S格式报文的APDU只包括APCI；  
2）S格式报文只能用来给予对方的报文序列号确认，不能用于传送信息。
（3）S格式报文的结构如下所示。   

0 1 1 0 1 0 0 0  
0 0 0 0 0 1 0 0  
0 0 0 0 0 0 0 1  
全0  
接收序列号N（R） |0  
接收序列号N（R）  
####U格式（Unnumbered Control Function)  
（不编号的控制功能格式，既没有发送序号也没有接收序号。主要用于控制信息传输流程。）  
（1）U格式报文的标志是在于：  
1）控制域第一位八位位组的第一位比特=1并且第二位比特=1；  
2）控制域第三个八位位组第一位比特=0。   
（2）特别规定：  
1）U格式报文的APDU只包括APCI；   
2）在同一时刻，测试（TESTFR),停止（STOPDT)或开启（STARTDT)中只有一个功能可以被激活。  
3）U格式报文只能用于传输规约的控制。  
（3）U格式的控制信息如下所示：

0 1 1 0 1 0 0 0  
0 0 0 0 0 1 0 0  
TESFR STOPDT STARTDT 1 1  
全0  
全0   
全0

### 1.3 应用服务数据单元（ASDU）
ASDU由数据单元标识符和信息体(n个）组成。  
数据单元标识符包括：   
类型标识，1个字节；   
可变结构限定词，1个字节；   
传送原因，2个字节；   
ASDU公共地址，2个字节。 

信息体包括：   
信息对象地址，3个字节；   
信息元素集，若干字节；   
时标，7个字节(可选)。 

一组信息元素集可以是单个信息元素/信息元素集合、单个信息元素序列或者信息元素集合序列。  
可变结构限定词是ASDU的第二个字节，其最高位=0表示后续的信息体的地址是不连续的，=1表示后续的信息体的地址是连续的。其余7位表示信息体的数量。   
在104中信息对象地址使用3个字节，范围为1...16777215。  
### 类型标识
类型标志定义了信息对象的结构、类型和格式。一个应用服务数据单元内全部信息对象由相同的结构、类型和格式。  

### 类型标识的作用

### 常见类型标识

发送原因
--------------------------------

### 发送原因的作用

### 常见发送原因

数据结构
-------------------------------

### 数据结构设计

### 常量设计

### APDU类

### 报文组装类

### 报文解析类

单元测试
-------------------------

### 什么是单元测试

### 报文组装类的测试

### 报文解析类的测试

本章小结
------------------------------  



